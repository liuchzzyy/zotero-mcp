name: Automated Zotero Analysis

# Schedule: 6:00 AM and 8:00 PM Beijing Time (UTC+8)
# Convert to UTC:
#   - 6:00 AM CST = 22:00 UTC (previous day)
#   - 8:00 PM CST = 12:00 UTC
on:
  schedule:
    # 6:00 AM Beijing Time (22:00 UTC)
    - cron: '0 22 * * *'
    # 8:00 PM Beijing Time (12:00 UTC)
    - cron: '0 12 * * *'
  
  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      max_items:
        description: 'Maximum items to process (leave empty for all)'
        required: false
        type: string

jobs:
  analyze-zotero:
    runs-on: ubuntu-latest
    
    # Use environment for secret protection
    environment: production
    
    # Set timeout to prevent runaway jobs (2 hours max)
    timeout-minutes: 120
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          enable-cache: true
      
      - name: Set up Python
        run: uv python install
      
      - name: Install Dependencies
        run: uv sync --locked
      
      - name: Run Automated Analysis
        env:
          ZOTERO_LIBRARY_ID: ${{ secrets.ZOTERO_LIBRARY_ID }}
          ZOTERO_API_KEY: ${{ secrets.ZOTERO_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          ZOTERO_LOCAL: "false"
          ZOTERO_LIBRARY_TYPE: "user"
        run: |
          echo "Starting automated Zotero analysis..."
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Beijing Time: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S CST')"
          echo ""
          
          uv run python scripts/auto_analyze.py
      
      - name: Upload Analysis Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analysis-logs-${{ github.run_number }}
          path: |
            *.log
            checkpoints/
          retention-days: 30
      
      - name: Notify on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Automated Zotero Analysis Failed',
              body: `**Workflow Run:** ${runUrl}\n\n**Time:** ${new Date().toISOString()}\n\n**Trigger:** ${context.eventName}\n\nPlease check the logs for details.`,
              labels: ['automated', 'failure']
            });

